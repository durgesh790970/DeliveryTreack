<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Your Cart - TiffinRush</title>
  {% load static %}
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { 
      font-family: 'Poppins', sans-serif; 
      background: linear-gradient(135deg, #fff5f2 0%, #ffe8df 25%, #f8f4e1 50%, #e8f5e8 75%, #f0f8f0 100%); 
      min-height: 100vh; 
      position: relative;
      overflow-x: hidden;
    }
    
    /* Enhanced Food Background Animation */
    .food-bg { 
      position: fixed; 
      top: 0; 
      left: 0; 
      width: 100%; 
      height: 100%; 
      pointer-events: none; 
      z-index: 0; 
      overflow: hidden;
    }
    
    .food-item { 
      position: absolute; 
      font-size: 25px; 
      opacity: 0.03; 
      animation: float 18s ease-in-out infinite; 
      filter: blur(1px) grayscale(40%);
      color: #ff6b35;
    }
    
    .food-item:nth-child(1) { top: 8%; left: 5%; animation-delay: 0s; }
    .food-item:nth-child(2) { top: 20%; right: 8%; animation-delay: 3s; }
    .food-item:nth-child(3) { bottom: 25%; left: 12%; animation-delay: 6s; }
    .food-item:nth-child(4) { bottom: 15%; right: 15%; animation-delay: 9s; }
    .food-item:nth-child(5) { top: 45%; left: 2%; animation-delay: 12s; }
    .food-item:nth-child(6) { top: 60%; right: 3%; animation-delay: 15s; }
    
    @keyframes float {
      0%, 100% { 
        transform: translateY(0px) translateX(0px); 
        opacity: 0.02; 
      }
      50% { 
        transform: translateY(-20px) translateX(10px); 
        opacity: 0.05; 
      }
    }
    
    /* Header */
    .cart-header { 
      background: rgba(255, 255, 255, 0.95); 
      backdrop-filter: blur(20px);
      padding: 20px; 
      box-shadow: 0 5px 30px rgba(0,0,0,0.1); 
      border-radius: 0 0 25px 25px; 
      position: sticky;
      top: 0;
      z-index: 100;
      border-bottom: 1px solid rgba(255,107,53,0.1);
    }
    .header-content { display: flex; align-items: center; gap: 20px; max-width: 1200px; margin: 0 auto; }
    
    .back-btn { 
      background: linear-gradient(135deg, #ff6b35, #4caf50); 
      color: white;
      border: none; 
      border-radius: 15px; 
      width: 50px; 
      height: 50px; 
      display: flex; 
      align-items: center; 
      justify-content: center; 
      font-size: 20px; 
      cursor: pointer; 
      transition: all 0.3s ease;
      text-decoration: none;
    }
    
    .back-btn:hover {
      transform: scale(1.05);
      box-shadow: 0 8px 25px rgba(255,107,53,0.3);
    }
    
    .header-title-section {
      flex: 1;
      display: flex;
      align-items: center;
      gap: 15px;
    }
    
    .logo {
      font-size: 32px;
      background: linear-gradient(135deg, #ff6b35, #4caf50);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      animation: logoFloat 3s ease-in-out infinite;
    }
    
    @keyframes logoFloat {
      0%, 100% { transform: translateY(0px); }
      50% { transform: translateY(-3px); }
    }
    
    .cart-title { 
      font-size: 28px; 
      font-weight: 800; 
      background: linear-gradient(135deg, #ff6b35, #4caf50);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    .cart-count { color: #666; font-size: 16px; font-weight: 600; }
    
    /* Cart Items */
    .cart-content { 
      padding: 30px 20px; 
      position: relative;
      z-index: 1;
      max-width: 1200px;
      margin: 0 auto;
    }
    
    .cart-item { 
      background: rgba(255, 255, 255, 0.95); 
      backdrop-filter: blur(20px);
      border-radius: 25px; 
      padding: 25px; 
      margin-bottom: 20px; 
      box-shadow: 0 15px 40px rgba(0,0,0,0.1); 
      display: flex; 
      align-items: center; 
      gap: 20px; 
      border: 1px solid rgba(255,107,53,0.1);
      transition: all 0.3s ease;
      animation: slideUp 0.6s ease-out;
    }
    
    .cart-item:hover {
      transform: translateY(-5px);
      box-shadow: 0 20px 50px rgba(0,0,0,0.12);
    }
    
    .item-image { 
      width: 90px; 
      height: 90px; 
      background: linear-gradient(135deg, #ff6b35, #4caf50); 
      border-radius: 20px; 
      display: flex; 
      align-items: center; 
      justify-content: center; 
      font-size: 40px; 
      color: white;
      box-shadow: 0 8px 25px rgba(255,107,53,0.2);
    }
    
    .item-details { flex: 1; }
    .item-name { 
      font-size: 20px; 
      font-weight: 700; 
      color: #333; 
      margin-bottom: 8px; 
    }
    .item-restaurant { 
      font-size: 16px; 
      color: #666; 
      margin-bottom: 12px; 
      font-weight: 500;
    }
    .item-price { 
      font-size: 18px; 
      font-weight: 800; 
      background: linear-gradient(135deg, #ff6b35, #4caf50);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    .quantity-controls { 
      display: flex; 
      align-items: center; 
      gap: 15px; 
      background: rgba(255,107,53,0.1);
      border-radius: 20px;
      padding: 8px 16px;
    }
    .qty-btn { 
      background: linear-gradient(135deg, #ff6b35, #4caf50); 
      color: white; 
      border: none; 
      border-radius: 12px; 
      width: 40px; 
      height: 40px; 
      display: flex; 
      align-items: center; 
      justify-content: center; 
      font-size: 20px; 
      font-weight: 800;
      cursor: pointer; 
      transition: all 0.3s ease;
    }
    
    .qty-btn:hover {
      transform: scale(1.1);
      box-shadow: 0 5px 15px rgba(255,107,53,0.3);
    }
    
    .qty-display { 
      font-size: 20px; 
      font-weight: 800; 
      color: #ff6b35; 
      min-width: 35px; 
      text-align: center; 
    }
    
    .remove-item-btn {
      background: rgba(255,71,87,0.1);
      color: #ff4757;
      border: none;
      border-radius: 12px;
      width: 40px;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
      cursor: pointer;
      transition: all 0.3s ease;
      margin-left: 10px;
    }
    
    .remove-item-btn:hover {
      background: rgba(255,71,87,0.2);
      transform: scale(1.1);
    }
    
    /* Empty Cart */
    .empty-cart { 
      text-align: center; 
      padding: 80px 20px; 
      position: relative;
      z-index: 1;
    }
    .empty-icon { 
      font-size: 120px; 
      margin-bottom: 30px; 
      background: linear-gradient(135deg, #ff6b35, #4caf50);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      animation: bounce 2s ease-in-out infinite;
    }
    
    @keyframes bounce {
      0%, 100% { transform: translateY(0px); }
      50% { transform: translateY(-10px); }
    }
    
    .empty-title { 
      font-size: 32px; 
      font-weight: 800; 
      margin-bottom: 15px; 
      background: linear-gradient(135deg, #ff6b35, #4caf50);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    .empty-subtitle { 
      font-size: 18px; 
      color: #666;
      font-weight: 500;
      margin-bottom: 40px; 
    }
    .browse-btn { 
      background: linear-gradient(135deg, #ff6b35 0%, #ffa726 50%, #4caf50 100%); 
      color: white; 
      border: none; 
      padding: 18px 35px; 
      border-radius: 25px; 
      font-size: 18px; 
      font-weight: 700; 
      cursor: pointer; 
      transition: all 0.3s ease;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      box-shadow: 0 10px 30px rgba(255,107,53,0.3);
    }
    
    .browse-btn:hover {
      transform: translateY(-3px);
      box-shadow: 0 15px 40px rgba(255,107,53,0.4);
    }
    
    /* Order Summary */
    .order-summary { 
      background: rgba(255, 255, 255, 0.95); 
      backdrop-filter: blur(20px);
      margin: 30px 20px; 
      border-radius: 25px; 
      padding: 30px; 
      box-shadow: 0 15px 40px rgba(0,0,0,0.1); 
      border: 1px solid rgba(255,107,53,0.1);
      position: relative;
      z-index: 1;
      max-width: 1160px;
      margin-left: auto;
      margin-right: auto;
    }
    .summary-title { 
      font-size: 24px; 
      font-weight: 800; 
      color: #333; 
      margin-bottom: 25px; 
      display: flex;
      align-items: center;
      gap: 12px;
    }
    
    .summary-icon {
      font-size: 28px;
      background: linear-gradient(135deg, #ff6b35, #4caf50);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    
    .summary-row { 
      display: flex; 
      justify-content: space-between; 
      margin-bottom: 15px; 
      padding: 8px 0;
    }
    .summary-label { 
      color: #666; 
      font-size: 18px; 
      font-weight: 500;
    }
    .summary-value { 
      font-weight: 700; 
      color: #333; 
      font-size: 18px; 
    }
    .total-row { 
      border-top: 2px solid rgba(255,107,53,0.2); 
      padding-top: 20px; 
      margin-top: 20px; 
    }
    .total-label { 
      font-size: 22px; 
      font-weight: 800; 
      color: #333; 
    }
    .total-value { 
      font-size: 24px; 
      font-weight: 900; 
      background: linear-gradient(135deg, #ff6b35, #4caf50);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    
    /* Checkout Button */
    .checkout-section { 
      padding: 30px 20px; 
      position: relative;
      z-index: 1;
      max-width: 1200px;
      margin: 0 auto;
    }
    .checkout-btn { 
      width: 100%; 
      background: linear-gradient(135deg, #ff6b35 0%, #ffa726 50%, #4caf50 100%); 
      color: white; 
      border: none; 
      padding: 20px 30px; 
      border-radius: 25px; 
      font-size: 20px; 
      font-weight: 800; 
      cursor: pointer; 
      box-shadow: 0 10px 30px rgba(255,107,53,0.3); 
      transition: all 0.3s ease;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      position: relative;
      overflow: hidden;
    }
    
    .checkout-btn::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
      transition: left 0.5s ease;
    }
    
    .checkout-btn:hover::before {
      left: 100%;
    }
    
    .checkout-btn:hover { 
      transform: translateY(-3px); 
      box-shadow: 0 15px 40px rgba(255,107,53,0.4); 
    }
    .checkout-btn:disabled { 
      background: linear-gradient(135deg, #ccc, #aaa); 
      cursor: not-allowed; 
      transform: none; 
      box-shadow: 0 5px 15px rgba(0,0,0,0.1); 
    }
    
    /* Toast Notification */
    .toast {
      position: fixed;
      top: 20px;
      right: 20px;
      background: linear-gradient(135deg, #4caf50, #8bc34a);
      color: white;
      padding: 16px 24px;
      border-radius: 25px;
      font-weight: 600;
      font-size: 14px;
      z-index: 10000;
      transform: translateX(100%);
      transition: all 0.4s ease;
      box-shadow: 0 10px 35px rgba(76,175,80,0.3);
      max-width: 300px;
    }
    
    .toast.show {
      transform: translateX(0);
    }
    
    .toast.error {
      background: linear-gradient(135deg, #ff4757, #ff6b7d);
      box-shadow: 0 10px 35px rgba(255,71,87,0.3);
    }
    
    /* Responsive Design */
    @media (max-width: 768px) {
      .cart-content, .checkout-section {
        padding: 20px 15px;
      }
      
      .order-summary {
        margin: 20px 15px;
      }
      
      .cart-item {
        flex-direction: column;
        text-align: center;
        gap: 15px;
      }
      
      .item-details {
        order: 1;
      }
      
      .quantity-controls {
        order: 2;
        justify-content: center;
      }
      
      .header-title-section {
        flex-direction: column;
        align-items: flex-start;
        gap: 5px;
      }
    }
    
    @keyframes slideUp {
      from { 
        transform: translateY(30px); 
        opacity: 0; 
      }
      to { 
        transform: translateY(0); 
        opacity: 1; 
      }
    }
  </style>
</head>
<body>
  <!-- Enhanced Food Background -->
  <div class="food-bg">
    <div class="food-item">üçï</div>
    <div class="food-item">üçî</div>
    <div class="food-item">üçú</div>
    <div class="food-item">üåÆ</div>
    <div class="food-item">üç∞</div>
    <div class="food-item">ü•§</div>
  </div>

  <!-- Header -->
  <div class="cart-header">
    <div class="header-content">
      <a href="/" class="back-btn">
        <i class="fas fa-arrow-left"></i>
      </a>
      <div class="header-title-section">
        <div class="logo">üçΩÔ∏è</div>
        <div>
          <h1 class="cart-title">Your Cart</h1>
          <p class="cart-count" id="itemCount">3 items</p>
        </div>
      </div>
    </div>
  </div>

  <!-- Cart Content -->
  <div class="cart-content" id="cartContent">
    <!-- Items will be rendered here by JavaScript -->
  </div>

  <!-- Empty Cart State (hidden by default) -->
  <div class="empty-cart" id="emptyCart" style="display: none;">
    <div class="empty-icon">üõí</div>
    <h2 class="empty-title">Your cart is empty!</h2>
    <p class="empty-subtitle">Add some delicious food to get started</p>
    <button class="browse-btn" onclick="window.location.href='/'">Browse Restaurants</button>
  </div>

  <!-- Order Summary -->
  <div class="order-summary" id="orderSummary">
    <h3 class="summary-title">
      <i class="fas fa-receipt summary-icon"></i>
      Order Summary
    </h3>
    <div class="summary-row">
      <span class="summary-label">Subtotal</span>
      <span class="summary-value" id="subtotal">‚Çπ1020</span>
    </div>
    <div class="summary-row">
      <span class="summary-label">Delivery Fee</span>
      <span class="summary-value">‚Çπ40</span>
    </div>
    <div class="summary-row">
      <span class="summary-label">Taxes & Charges</span>
      <span class="summary-value" id="taxes">‚Çπ82</span>
    </div>
    <div class="summary-row">
      <span class="summary-label">Discount</span>
      <span class="summary-value" style="color: #4caf50;">-‚Çπ0</span>
    </div>
    <div class="summary-row total-row">
      <span class="total-label">Total Amount</span>
      <span class="total-value" id="total">‚Çπ11</span>
    </div>
    
    <!-- Real-time Order Items (shows only items user is about to order) -->
    <div style="margin-top:20px;">
      <h4 style="font-size:18px; font-weight:700; margin-bottom:10px; color:#333">Order Items</h4>
      <div id="orderItemsContainer" style="display:flex;flex-direction:column;gap:10px;">
        <!-- Filled by JS: each row shows name, qty and line total -->
      </div>
    </div>
  </div>

  <!-- Checkout Button -->
  <div class="checkout-section">
    <button class="checkout-btn" onclick="proceedToCheckout()">
      <i class="fas fa-lock" style="margin-right: 10px;"></i>
      Proceed to Checkout ‚Ä¢ ‚Çπ1142
    </button>
  </div>

  <script>
    // Vanilla JS cart: localStorage persistence + best-effort server sync
    const CART_KEY = 'tiffin_cart';
    const CSRF_TOKEN = (document.cookie.split(';').map(c=>c.trim()).find(c=>c.startsWith('csrftoken='))||'').split('=')[1] || '';

    function loadCart(){ try{ return JSON.parse(localStorage.getItem(CART_KEY) || '[]'); }catch(e){ return []; } }
    function saveCart(cart){ localStorage.setItem(CART_KEY, JSON.stringify(cart)); }

    // Server API calls (best-effort)
    async function apiAdd(item){ try{ const r = await fetch('/api/cart/', { method:'POST', headers: {'Content-Type':'application/json','X-CSRFToken':CSRF_TOKEN}, body: JSON.stringify(Object.assign({action:'add'}, item)) }); return await r.json(); }catch(e){ return {success:false}; } }
    async function apiRemove(item){ try{ const r = await fetch('/api/cart/', { method:'POST', headers: {'Content-Type':'application/json','X-CSRFToken':CSRF_TOKEN}, body: JSON.stringify(Object.assign({action:'remove'}, item)) }); return await r.json(); }catch(e){ return {success:false}; } }
    async function apiUpdate(item){ try{ const r = await fetch('/api/cart/', { method:'PATCH', headers: {'Content-Type':'application/json','X-CSRFToken':CSRF_TOKEN}, body: JSON.stringify(Object.assign({action:'update'}, item)) }); return await r.json(); }catch(e){ return {success:false}; } }
    async function apiCheckout(){ try{ const r = await fetch('/api/cart/checkout/', { method:'POST', headers: {'X-CSRFToken':CSRF_TOKEN} }); return await r.json(); }catch(e){ return {success:false}; } }

    // UI utilities
    function showToast(msg, type='success', duration=2500){ const t=document.createElement('div'); t.className='toast'+(type==='error'?' error':''); t.textContent=msg; document.body.appendChild(t); setTimeout(()=>t.classList.add('show'),50); setTimeout(()=>{ t.classList.remove('show'); setTimeout(()=>t.remove(),350); }, duration); }

    function flyToCart(fromEl){ try{ const rect = fromEl.getBoundingClientRect(); const fly=document.createElement('div'); fly.className='fly-img'; fly.textContent='üçΩÔ∏è'; fly.style.left=rect.left+'px'; fly.style.top=rect.top+'px'; document.body.appendChild(fly); const cartIcon=document.querySelector('.logo') || document.querySelector('.back-btn'); const toRect = (document.querySelector('.logo')||document.querySelector('.back-btn')).getBoundingClientRect(); requestAnimationFrame(()=>{ fly.style.transform = `translate(${toRect.left-rect.left}px, ${toRect.top-rect.top}px) scale(0.2)`; fly.style.opacity='0.2'; }); setTimeout(()=>fly.remove(),800);}catch(e){} }

    // DOM rendering
    function renderCart(){ const container = document.getElementById('cartContent'); container.innerHTML=''; const cart = loadCart(); if(!cart.length){ document.getElementById('cartContent').style.display='none'; document.getElementById('orderSummary').style.display='none'; document.querySelector('.checkout-section').style.display='none'; document.getElementById('emptyCart').style.display='block'; document.getElementById('itemCount').textContent='0 items'; return; } document.getElementById('cartContent').style.display='block'; document.getElementById('orderSummary').style.display='block'; document.querySelector('.checkout-section').style.display='block'; document.getElementById('emptyCart').style.display='none';
      cart.forEach((it, idx)=>{ const el=document.createElement('div'); el.className='cart-item'; el.innerHTML = `
        <div class="item-image">${it.image||'üçΩÔ∏è'}</div>
        <div class="item-details">
          <h3 class="item-name">${it.name}</h3>
          <p class="item-restaurant">${it.restaurant||''}</p>
          <p class="item-price">‚Çπ${it.price}</p>
        </div>
        <div class="quantity-controls">
          <button class="qty-btn" data-idx="${idx}" data-op="dec">-</button>
          <span class="qty-display">${it.qty||1}</span>
          <button class="qty-btn" data-idx="${idx}" data-op="inc">+</button>
        </div>
        <button class="remove-item-btn" data-idx="${idx}" title="Remove item"><i class="fas fa-trash"></i></button>`;
        container.appendChild(el);
      }); updateCartSummary(); }

    // Render a compact order summary listing only the items being ordered
    function renderOrderSummary(){
      const container = document.getElementById('orderItemsContainer');
      if(!container) return;
      const cart = loadCart();
      container.innerHTML = '';
      if(!cart.length){
        const empty = document.createElement('div'); empty.style.color='#666'; empty.textContent = 'No items selected.'; container.appendChild(empty); return;
      }
      cart.forEach(it=>{
        const row = document.createElement('div');
        row.style.display = 'flex';
        row.style.justifyContent = 'space-between';
        row.style.alignItems = 'center';
        row.style.padding = '8px 10px';
        row.style.background = 'rgba(0,0,0,0.03)';
        row.style.borderRadius = '12px';
        row.innerHTML = `<div style="display:flex;gap:12px;align-items:center"><div style="width:36px;height:36px;border-radius:8px;background:linear-gradient(135deg,#ff6b35,#4caf50);display:flex;align-items:center;justify-content:center;color:white;font-size:18px">${it.image||'üçΩÔ∏è'}</div><div style="min-width:160px"><div style="font-weight:700;color:#333">${it.name}</div><div style="font-size:12px;color:#777">${it.restaurant||''}</div></div></div><div style="display:flex;gap:12px;align-items:center"><div style="font-weight:800;color:#ff6b35">x${it.qty||1}</div><div style="font-weight:800">‚Çπ${(it.price*(it.qty||1))}</div></div>`;
        container.appendChild(row);
      });
    }

    function updateCartSummary(){
      const cart = loadCart();
      let subtotal=0, totalItems=0;
      cart.forEach(it=>{ subtotal += (it.price*(it.qty||1)); totalItems += (it.qty||1); });
      const deliveryFee=40;
      const taxes = Math.round(subtotal*0.08);
      const total = subtotal+deliveryFee+taxes;
      document.getElementById('subtotal').textContent=`‚Çπ${subtotal}`;
      document.getElementById('taxes').textContent=`‚Çπ${taxes}`;
      document.getElementById('total').textContent=`‚Çπ${total}`;
      document.getElementById('itemCount').textContent=`${totalItems} item${totalItems!==1?'s':''}`;
      const checkoutBtn = document.querySelector('.checkout-btn');
      if(checkoutBtn) checkoutBtn.innerHTML = `<i class="fas fa-lock" style="margin-right:10px"></i> Proceed to Checkout ‚Ä¢ ‚Çπ${total}`;

      // keep the compact order summary in sync with the cart totals
      renderOrderSummary();
    }

    // Cart operations
    async function addItem(item, fromEl){ const cart=loadCart(); const existing = cart.find(ci=>ci.name===item.name && ci.price===item.price); if(existing) existing.qty = (existing.qty||1) + (item.qty||1); else cart.push(Object.assign({qty: item.qty||1}, item)); saveCart(cart); renderCart(); flyToCart(fromEl); showToast('Item added to cart successfully!'); try{ await apiAdd(item); }catch(e){} }
    async function changeQty(idx, delta){ const cart=loadCart(); if(!cart[idx]) return; cart[idx].qty = (cart[idx].qty||1) + delta; if(cart[idx].qty < 1){ cart.splice(idx,1); } saveCart(cart); renderCart(); try{ if(delta>0) await apiAdd({name:cart[idx] && cart[idx].name, price:cart[idx] && cart[idx].price, qty:delta}); else await apiRemove({name:cart[idx] && cart[idx].name, price:cart[idx] && cart[idx].price}); }catch(e){} }
    async function removeAt(idx){ const cart=loadCart(); if(!cart[idx]) return; const name = cart[idx].name; cart.splice(idx,1); saveCart(cart); renderCart(); showToast(`${name} removed from cart`, 'error'); try{ await apiUpdate({name, price:0, qty:0}); }catch(e){} }

    // Checkout
    async function proceedToCheckout(){
      const cart = loadCart();
      if(!cart || !cart.length){
        // requirement: alert the user and do not redirect
        alert('Cart is empty');
        return;
      }

      // compute totals and store checkout data in localStorage so checkout.html can read it
      const subtotal = cart.reduce((s,i)=>s + (i.price*(i.qty||1)), 0);
      const deliveryFee = 40;
      const taxes = Math.round(subtotal * 0.08);
      const total = subtotal + deliveryFee + taxes;

      const checkoutData = {
        items: cart,
        subtotal: subtotal,
        deliveryFee: deliveryFee,
        taxes: taxes,
        total: total,
        timestamp: Date.now()
      };

      localStorage.setItem('checkout_data', JSON.stringify(checkoutData));

  // ensure order summary is up-to-date before redirect
  renderOrderSummary();

      // Redirect to checkout page (same tab)
      window.location.href = '/checkout/';
    }

    // Event delegation for qty and remove
    document.addEventListener('click', function(e){ const t=e.target; if(t.matches('.qty-btn')){ const idx = parseInt(t.getAttribute('data-idx'),10); const op = t.getAttribute('data-op'); changeQty(idx, op==='inc'?1:-1); } if(t.matches('.remove-item-btn')){ const idx = parseInt(t.getAttribute('data-idx'),10); if(confirm('Remove this item?')) removeAt(idx); } });

    // Expose addItem for other pages (e.g., menu) to call when user adds an item and lands on cart page
    window.addItemToCartFromOther = function(item, fromEl){ addItem(item, fromEl); };

    // Initialize
    document.addEventListener('DOMContentLoaded', function(){ renderCart(); // if empty show empty later
      // welcome toast
      setTimeout(()=> showToast('üçΩÔ∏è Review your selections!'), 900);
      // wire checkout button
      document.querySelector('.checkout-btn').addEventListener('click', function(){ proceedToCheckout(); });
    });
  </script>
</body>
</html>
